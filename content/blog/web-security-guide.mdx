---
title: "Web 安全防护完全指南"
description: "全面了解Web应用安全威胁与防护措施，构建安全可靠的网络应用程序。"
date: "2024-03-02"
author: "安全团队"
category: "网络安全"
tags: ["安全", "Web安全", "防护", "漏洞"]
image: "https://images.unsplash.com/photo-1555949963-aa79dcee981c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2340&q=80"
featured: false
readingTime: 11
---

# Web 安全防护完全指南

Web应用安全是现代软件开发中的重要组成部分。本指南将帮助你了解常见的安全威胁以及相应的防护措施。

## OWASP Top 10 安全风险

### 1. 注入攻击 (Injection)

最常见的是SQL注入攻击：

```javascript
// ❌ 危险的SQL查询
const query = `SELECT * FROM users WHERE id = ${userId}`;

// ✅ 使用参数化查询
const query = 'SELECT * FROM users WHERE id = ?';
db.query(query, [userId], (err, results) => {
  // 安全的查询执行
});

// ✅ 使用ORM防护
const user = await User.findByPk(userId);
```

#### 防护措施

```javascript
// 输入验证和清理
function sanitizeInput(input) {
  return input.replace(/[<>]/g, '');
}

// 使用白名单验证
function validateUserId(id) {
  const pattern = /^[0-9]+$/;
  return pattern.test(id);
}

// SQL注入防护
const prepared = db.prepare('SELECT * FROM users WHERE email = ?');
const user = prepared.get(email);
```

### 2. 失效的身份认证

```javascript
// ❌ 弱密码策略
const weakPassword = '123456';

// ✅ 强密码要求
function validatePassword(password) {
  const minLength = 8;
  const hasUpperCase = /[A-Z]/.test(password);
  const hasLowerCase = /[a-z]/.test(password);
  const hasNumbers = /\d/.test(password);
  const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);
  
  return password.length >= minLength && 
         hasUpperCase && hasLowerCase && 
         hasNumbers && hasSpecialChar;
}

// 密码加密存储
const bcrypt = require('bcrypt');
const saltRounds = 12;

async function hashPassword(password) {
  return await bcrypt.hash(password, saltRounds);
}

async function verifyPassword(password, hash) {
  return await bcrypt.compare(password, hash);
}
```

### 3. 敏感数据暴露

```javascript
// ✅ 环境变量管理
require('dotenv').config();

const config = {
  database: {
    host: process.env.DB_HOST,
    username: process.env.DB_USER,
    password: process.env.DB_PASSWORD
  },
  jwt: {
    secret: process.env.JWT_SECRET
  }
};

// ✅ 数据加密
const crypto = require('crypto');

function encrypt(text, key) {
  const algorithm = 'aes-256-gcm';
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipher(algorithm, key, iv);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  return {
    encrypted,
    iv: iv.toString('hex'),
    tag: cipher.getAuthTag().toString('hex')
  };
}
```

### 4. XML外部实体攻击 (XXE)

```javascript
// ❌ 不安全的XML解析
const xml2js = require('xml2js');
const parser = new xml2js.Parser();

// ✅ 安全的XML解析配置
const parser = new xml2js.Parser({
  explicitArray: false,
  explicitRoot: false,
  // 禁用外部实体
  parseStringOptions: {
    explicitDoctype: false
  }
});

// 使用安全的XML库
const libxmljs = require('libxmljs');
const doc = libxmljs.parseXml(xmlString, {
  noent: false,  // 禁用实体扩展
  nonet: true    // 禁用网络访问
});
```

## 身份验证与授权

### JWT 安全实践

```javascript
const jwt = require('jsonwebtoken');

// ✅ 安全的JWT配置
function generateToken(payload) {
  return jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: '1h',
    issuer: 'your-app',
    audience: 'your-users'
  });
}

// Token验证中间件
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];
  
  if (!token) {
    return res.sendStatus(401);
  }
  
  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
    if (err) return res.sendStatus(403);
    req.user = user;
    next();
  });
}

// 刷新令牌机制
function generateRefreshToken(userId) {
  return jwt.sign({ userId }, process.env.REFRESH_SECRET, {
    expiresIn: '7d'
  });
}
```

### 角色权限控制

```javascript
// 基于角色的访问控制 (RBAC)
const permissions = {
  admin: ['read', 'write', 'delete'],
  editor: ['read', 'write'],
  viewer: ['read']
};

function hasPermission(userRole, requiredPermission) {
  const userPermissions = permissions[userRole] || [];
  return userPermissions.includes(requiredPermission);
}

// 权限检查中间件
function requirePermission(permission) {
  return (req, res, next) => {
    if (!hasPermission(req.user.role, permission)) {
      return res.status(403).json({ error: '权限不足' });
    }
    next();
  };
}

// 使用示例
app.delete('/api/users/:id', 
  authenticateToken, 
  requirePermission('delete'), 
  deleteUser
);
```

## 跨站脚本攻击 (XSS) 防护

### 输出编码

```javascript
// ✅ HTML实体编码
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// 使用DOMPurify库
const createDOMPurify = require('isomorphic-dompurify');
const DOMPurify = createDOMPurify();

function sanitizeHtml(dirty) {
  return DOMPurify.sanitize(dirty);
}
```

### 内容安全策略 (CSP)

```javascript
// Express CSP配置
const helmet = require('helmet');

app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    scriptSrc: ["'self'", "'unsafe-inline'", "https://trusted-cdn.com"],
    styleSrc: ["'self'", "'unsafe-inline'"],
    imgSrc: ["'self'", "data:", "https:"],
    connectSrc: ["'self'"],
    fontSrc: ["'self'"],
    objectSrc: ["'none'"],
    mediaSrc: ["'self'"],
    frameSrc: ["'none'"]
  }
}));

// 手动设置CSP头
app.use((req, res, next) => {
  res.setHeader(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline'"
  );
  next();
});
```

## 跨站请求伪造 (CSRF) 防护

```javascript
const csrf = require('csurf');

// CSRF保护中间件
const csrfProtection = csrf({ cookie: true });

app.use(csrfProtection);

// 提供CSRF令牌给前端
app.get('/api/csrf-token', (req, res) => {
  res.json({ csrfToken: req.csrfToken() });
});

// 验证CSRF令牌
app.post('/api/sensitive-action', (req, res) => {
  // CSRF令牌会自动验证
  // 执行敏感操作
});

// 前端使用CSRF令牌
fetch('/api/sensitive-action', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': csrfToken
  },
  body: JSON.stringify(data)
});
```

## 会话安全

```javascript
const session = require('express-session');
const MongoStore = require('connect-mongo');

// 安全的会话配置
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  store: MongoStore.create({
    mongoUrl: process.env.MONGODB_URI
  }),
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only
    httpOnly: true,                               // 防止XSS
    maxAge: 1000 * 60 * 60 * 24,                 // 24小时
    sameSite: 'strict'                           // CSRF保护
  }
}));
```

## 输入验证

```javascript
const Joi = require('joi');

// 定义验证模式
const userSchema = Joi.object({
  username: Joi.string().alphanum().min(3).max(30).required(),
  email: Joi.string().email().required(),
  password: Joi.string().min(8).required(),
  age: Joi.number().integer().min(18).max(100)
});

// 验证中间件
function validateInput(schema) {
  return (req, res, next) => {
    const { error } = schema.validate(req.body);
    if (error) {
      return res.status(400).json({
        error: error.details[0].message
      });
    }
    next();
  };
}

// 使用验证
app.post('/api/users', 
  validateInput(userSchema), 
  createUser
);

// 自定义验证函数
function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function validatePhoneNumber(phone) {
  const phoneRegex = /^\+?[1-9]\d{1,14}$/;
  return phoneRegex.test(phone);
}
```

## 文件上传安全

```javascript
const multer = require('multer');
const path = require('path');

// 安全的文件上传配置
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/');
  },
  filename: (req, file, cb) => {
    // 生成安全的文件名
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB限制
    files: 1
  },
  fileFilter: (req, file, cb) => {
    // 白名单文件类型
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('不支持的文件类型'), false);
    }
  }
});

// 文件类型验证
function validateFileType(file) {
  const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif'];
  const fileExtension = path.extname(file.originalname).toLowerCase();
  return allowedExtensions.includes(fileExtension);
}
```

## API 安全

### 速率限制

```javascript
const rateLimit = require('express-rate-limit');

// 基本速率限制
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100,                  // 最多100个请求
  message: '请求过于频繁，请稍后再试'
});

// 严格的登录速率限制
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  skipSuccessfulRequests: true,
  message: '登录尝试过多，请15分钟后再试'
});

app.use('/api/', limiter);
app.use('/api/login', loginLimiter);

// 基于IP的动态限制
const slowDown = require('express-slow-down');

const speedLimiter = slowDown({
  windowMs: 15 * 60 * 1000,
  delayAfter: 50,
  delayMs: 500
});

app.use('/api/', speedLimiter);
```

### API密钥管理

```javascript
// API密钥验证中间件
function authenticateApiKey(req, res, next) {
  const apiKey = req.headers['x-api-key'];
  
  if (!apiKey) {
    return res.status(401).json({ error: '缺少API密钥' });
  }
  
  // 验证API密钥
  if (!isValidApiKey(apiKey)) {
    return res.status(403).json({ error: '无效的API密钥' });
  }
  
  // 记录API使用情况
  logApiUsage(apiKey, req.path);
  
  next();
}

function isValidApiKey(key) {
  // 从数据库或缓存中验证
  return validApiKeys.includes(key);
}
```

## 数据库安全

```javascript
// MongoDB安全连接
const mongoose = require('mongoose');

const dbOptions = {
  useNewUrlParser: true,
  useUnifiedTopology: true,
  authSource: 'admin',
  ssl: true,
  sslValidate: true
};

mongoose.connect(process.env.MONGODB_URI, dbOptions);

// SQL查询安全
const mysql = require('mysql2/promise');

// 连接池配置
const pool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  ssl: {
    rejectUnauthorized: true
  },
  connectionLimit: 10,
  acquireTimeout: 60000,
  timeout: 60000
});

// 安全的查询执行
async function getUserById(userId) {
  const [rows] = await pool.execute(
    'SELECT id, username, email FROM users WHERE id = ?',
    [userId]
  );
  return rows[0];
}
```

## 安全响应头

```javascript
const helmet = require('helmet');

// 使用Helmet设置安全头
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));

// 手动设置安全头
app.use((req, res, next) => {
  // 防止点击劫持
  res.setHeader('X-Frame-Options', 'DENY');
  
  // 防止MIME类型嗅探
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  // XSS保护
  res.setHeader('X-XSS-Protection', '1; mode=block');
  
  // 引用者策略
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  next();
});
```

## 日志和监控

```javascript
const winston = require('winston');

// 安全日志配置
const securityLogger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ 
      filename: 'security.log',
      level: 'warn'
    })
  ]
});

// 记录安全事件
function logSecurityEvent(event, details) {
  securityLogger.warn('Security Event', {
    event,
    details,
    timestamp: new Date().toISOString(),
    ip: details.ip,
    userAgent: details.userAgent
  });
}

// 监控可疑活动
function detectSuspiciousActivity(req) {
  const indicators = [
    req.headers['user-agent']?.includes('sqlmap'),
    req.url.includes('../'),
    req.body && JSON.stringify(req.body).includes('<script>')
  ];
  
  if (indicators.some(indicator => indicator)) {
    logSecurityEvent('Suspicious Activity', {
      ip: req.ip,
      url: req.url,
      userAgent: req.headers['user-agent']
    });
  }
}
```

## 安全测试

```javascript
// 安全测试示例
const request = require('supertest');
const app = require('../app');

describe('Security Tests', () => {
  // SQL注入测试
  test('应该防护SQL注入攻击', async () => {
    const maliciousInput = "1' OR '1'='1";
    
    const response = await request(app)
      .get(`/api/users/${maliciousInput}`)
      .expect(400);
    
    expect(response.body.error).toContain('无效的用户ID');
  });
  
  // XSS测试
  test('应该防护XSS攻击', async () => {
    const xssPayload = '<script>alert("xss")</script>';
    
    const response = await request(app)
      .post('/api/comments')
      .send({ content: xssPayload })
      .expect(400);
  });
  
  // CSRF测试
  test('应该要求CSRF令牌', async () => {
    const response = await request(app)
      .post('/api/sensitive-action')
      .send({ data: 'test' })
      .expect(403);
  });
});
```

## 总结

Web安全是一个持续的过程，需要：

1. **了解威胁**：熟悉OWASP Top 10和常见攻击
2. **防御深度**：多层安全防护措施
3. **安全编码**：从开发阶段就考虑安全
4. **持续监控**：实时检测和响应安全事件
5. **定期更新**：保持依赖库和系统的最新状态

记住，安全不是一次性的工作，而是需要持续关注和改进的过程。 